generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           String   @id @default(uuid())
  firstName                    String   @map("first_name")
  lastName                     String   @map("last_name")
  businessName                 String?  @map("business_name")
  address                      String?
  email                        String   @unique
  phoneNumber                  String   @unique @map("phone_number")
  passwordHash                 String   @map("password_hash")
  role                         Role     @default(AGENT)
  isPhoneVerified              Boolean  @default(false) @map("is_phone_verified")
  isEmailVerified              Boolean  @default(false) @map("is_email_verified")
  isIdentityVerified           Boolean  @default(false) @map("is_identity_verified")
  createdAt                    DateTime @default(now()) @map("created_at")
  bvn                          String?
  nin                          String?
  hasAgreedToModificationTerms Boolean  @default(false) @map("has_agreed_to_mod_terms")
  isBlocked                    Boolean  @default(false) @map("is_blocked")
  
  // --- Chat Blocking ---
  isChatBlocked                Boolean  @default(false) @map("is_chat_blocked")

  // --- FIELD: AGENT CODE ---
  agentCode                    String?  @unique @map("agent_code") 

  // --- AGGREGATOR FIELDS ---
  subdomain                    String?  @unique
  accountName                  String?  @map("account_name")
  accountNumber                String?  @map("account_number")
  bankName                     String?  @map("bank_name")
  
  aggregatorId                 String?  @map("aggregator_id")
  aggregator                   User?    @relation("AgentToAggregator", fields: [aggregatorId], references: [id])
  agents                       User[]   @relation("AgentToAggregator")
  
  aggregatorPrices             AggregatorPrice[]
  withdrawalRequests           WithdrawalRequest[]
  pendingAccountChanges        PendingAccountChange[]
  
  // --- Relations ---
  wallet                       Wallet?
  virtualAccounts              VirtualAccount[]
  transactions                 Transaction[]
  ninVerifications             NinVerification[]
  personalizationRequests      PersonalizationRequest[]
  ipeRequests                  IpeRequest[]
  validationRequests           ValidationRequest[]
  modificationRequests         ModificationRequest[]
  delinkRequests               DelinkRequest[]
  newspaperRequests            NewspaperRequest[]
  cacRequests                  CacRequest[]
  tinRequests                  TinRequest[]
  jambRequests                 JambRequest[]
  examPinRequests              ExamPinRequest[]
  resultRequests               ResultRequest[]
  vtuRequests                  VtuRequest[]
  bvnRequests                  BvnRequest[]
  vninRequests                 VninRequest[] // <--- ADDED THIS
  otps                         Otp[]
  
  // --- Chat Messages ---
  chatMessages                 ChatMessage[]

  @@map("users")
}

model Wallet {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  balance            Decimal  @default(0.00) @db.Decimal(12, 2)
  updatedAt          DateTime @updatedAt @map("updated_at")
  user               User     @relation(fields: [userId], references: [id])
  
  commissionBalance  Decimal  @default(0.00) @map("commission_balance") @db.Decimal(12, 2)
  
  @@map("wallets")
}

model VirtualAccount {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  bankName      String   @map("bank_name")
  accountNumber String   @unique @map("account_number")
  accountName   String   @map("account_name")
  accountType   String   @default("STATIC") @map("account_type")
  reference     String   @unique
  user          User     @relation(fields: [userId], references: [id])
  @@map("virtual_accounts")
}

model Transaction {
  id             String            @id @default(uuid())
  userId         String            @map("user_id")
  type           String
  amount         Decimal           @db.Decimal(12, 2)
  description    String
  reference      String            @unique
  status         String
  createdAt      DateTime          @default(now()) @map("created_at")
  serviceId      String?           @map("service_id")
  service        Service?          @relation(fields: [serviceId], references: [id])
  user           User              @relation(fields: [userId], references: [id])
  verificationId String?           @map("verification_id")
  verification   NinVerification?  @relation(fields: [verificationId], references: [id], onDelete: SetNull)

  @@map("transactions")
}

model NinVerification {
  id           String        @id @default(uuid())
  userId       String        @map("user_id")
  data         Json
  expiresAt    DateTime      @map("expires_at")
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  @@map("nin_verifications")
}

model Otp {
  id        String   @id @default(uuid())
  code      String
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("otps")
}

model Service {
  id                  String                @id
  name                String
  category            String
  
  platformPrice       Decimal  @default(0.00) @map("platform_price") @db.Decimal(10, 2)
  defaultAgentPrice   Decimal  @default(0.00) @map("default_agent_price") @db.Decimal(10, 2)
  defaultCommission   Decimal  @default(0.00) @map("default_commission") @db.Decimal(10, 2)

  isActive            Boolean  @default(true) @map("is_active")
  productCode         String?  @map("product_code")
  
  Transaction         Transaction[]
  ModificationRequest ModificationRequest[]
  NewspaperRequest    NewspaperRequest[]
  CacRequest          CacRequest[]
  TinRequest          TinRequest[]
  JambRequest         JambRequest[]
  ExamPinRequest      ExamPinRequest[]
  ResultRequest       ResultRequest[]
  VtuRequest          VtuRequest[]
  BvnRequest          BvnRequest[]
  VninRequest         VninRequest[] // <--- ADDED THIS
  AggregatorPrice     AggregatorPrice[]
  
  @@map("services")
}

enum RequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model BvnEnrollmentResult {
  id               String   @id @default(uuid())
  ticketNumber     String   @unique @map("ticket_number") 
  bvn              String?  @map("bvn")                   
  institutionName  String?  @map("institution_name")      
  agentName        String?  @map("agent_name")            
  agentCode        String   @map("agent_code")            
  bmsImportId      String?  @map("bms_import_id")         
  status           String   @map("status")                
  message          String?  @map("message")               
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  @@index([agentCode])
  @@map("bvn_enrollment_results")
}

model PersonalizationRequest {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  trackingId    String        @map("tracking_id")
  status        RequestStatus @default(PROCESSING)
  statusMessage String?       @map("status_message")
  data          Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  user          User          @relation(fields: [userId], references: [id])
  @@unique([userId, trackingId])
  @@map("personalization_requests")
}

model IpeRequest {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  trackingId    String        @map("tracking_id")
  newTrackingId String?       @map("new_tracking_id")
  status        RequestStatus @default(PROCESSING)
  statusMessage String?       @map("status_message")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  user          User          @relation(fields: [userId], references: [id])
  @@unique([userId, trackingId])
  @@map("ipe_requests")
}

model ValidationRequest {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  nin           String        @map("nin")
  scode         String
  newTrackingId String?       @map("new_tracking_id")
  status        RequestStatus @default(PROCESSING)
  statusMessage String?       @map("status_message")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  user          User          @relation(fields: [userId], references: [id])
  @@unique([userId, nin, scode])
  @@map("validation_requests")
}

model ModificationRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  serviceId       String        @map("service_id")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  formData        Json
  attestationUrl  String?       @map("attestation_url")
  uploadedSlipUrl String?       @map("uploaded_slip_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  @@map("modification_requests")
}

model DelinkRequest {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  nin           String        @map("nin")
  status        RequestStatus @default(PENDING)
  statusMessage String?       @map("status_message")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  user          User          @relation(fields: [userId], references: [id])
  @@map("delink_requests")
}

model NewspaperRequest {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  serviceId      String        @map("service_id")
  status         RequestStatus @default(PENDING)
  statusMessage  String?       @map("status_message")
  formData       Json
  publicationUrl String?       @map("publication_url")
  pageNumber     String?       @map("page_number")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  user           User          @relation(fields: [userId], references: [id])
  service        Service       @relation(fields: [serviceId], references: [id])
  @@map("newspaper_requests")
}

model CacRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  serviceId       String        @map("service_id")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  formData        Json
  passportUrl     String?       @map("passport_url")
  signatureUrl    String?       @map("signature_url")
  ninSlipUrl      String?       @map("nin_slip_url")
  certificateUrl  String?       @map("certificate_url")
  statusReportUrl String?       @map("status_report_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  @@map("cac_requests")
}

model TinRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  serviceId       String        @map("service_id")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  formData        Json
  statusReportUrl String?       @map("status_report_url")
  certificateUrl  String?       @map("certificate_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  @@map("tin_requests")
}

model JambRequest {
  id                String        @id @default(uuid())
  userId            String        @map("user_id")
  serviceId         String        @map("service_id")
  status            RequestStatus @default(PENDING)
  statusMessage     String?       @map("status_message")
  formData          Json
  uploadedSlipUrl   String?       @map("uploaded_slip_url")
  profileCodeResult String?       @map("profile_code_result")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  user              User          @relation(fields: [userId], references: [id])
  service           Service       @relation(fields: [serviceId], references: [id])
  @@map("jamb_requests")
}

model ExamPinRequest {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  serviceId     String   @map("service_id")
  userReference String   @unique @map("user_reference")
  phoneNumber   String   @map("phone_number")
  quantity      Int
  status        String
  apiResponse   Json?
  pins          Json?
  createdAt     DateTime @default(now()) @map("created_at")
  user          User     @relation(fields: [userId], references: [id])
  service       Service  @relation(fields: [serviceId], references: [id])
  @@map("exam_pin_requests")
}

model ResultRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  serviceId       String        @map("service_id")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  formData        Json
  uploadedSlipUrl String?       @map("uploaded_slip_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  @@map("result_requests")
}

model VtuRequest {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  serviceId     String   @map("service_id")
  userReference String   @unique @map("user_reference")
  phoneNumber   String?  @map("phone_number")
  meterNumber   String?  @map("meter_number")
  amount        Decimal  @db.Decimal(12, 2)
  quantity      Int?     @default(1)
  status        String
  apiResponse   Json?
  token         String?
  units         String?
  pins          Json?
  createdAt     DateTime @default(now()) @map("created_at")
  user          User     @relation(fields: [userId], references: [id])
  service       Service  @relation(fields: [serviceId], references: [id])
  @@map("vtu_requests")
}

model BvnRequest {
  id                  String        @id @default(uuid())
  userId              String        @map("user_id")
  serviceId           String        @map("service_id")
  status              RequestStatus @default(PENDING)
  statusMessage       String?       @map("status_message")
  formData            Json
  
  failedEnrollmentUrl String?       @map("failed_enrollment_url")
  vninSlipUrl         String?       @map("vnin_slip_url")
  uploadedSlipUrl     String?       @map("uploaded_slip_url")
  retrievalResult     String?       @map("retrieval_result")
  newspaperUrl        String?       @map("newspaper_url")
  
  adminResultUrl      String?       @map("admin_result_url")

  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  user                User          @relation(fields: [userId], references: [id])
  service             Service       @relation(fields: [serviceId], references: [id])
  
  @@map("bvn_requests")
}

// --- NEW MODEL: VNIN SLIP REQUESTS ---
model VninRequest {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  serviceId     String        @map("service_id")
  nin           String        @map("nin")
  status        RequestStatus @default(PROCESSING)
  statusMessage String?       @map("status_message")
  
  // We do not store the full Base64 PDF in DB (too large), 
  // but we can store a status or metadata if needed.
  
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user          User          @relation(fields: [userId], references: [id])
  service       Service       @relation(fields: [serviceId], references: [id])

  @@map("vnin_requests")
}
// -------------------------------------

model AggregatorPrice {
  id           String   @id @default(uuid())
  aggregatorId String   @map("aggregator_id")
  serviceId    String   @map("service_id")
  commission   Decimal  @db.Decimal(10, 2)
  
  aggregator   User     @relation(fields: [aggregatorId], references: [id])
  service      Service  @relation(fields: [serviceId], references: [id])
  
  @@unique([aggregatorId, serviceId])
  @@map("aggregator_prices")
}

model WithdrawalRequest {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  amount      Decimal       @db.Decimal(12, 2)
  status      RequestStatus @default(PENDING)
  createdAt   DateTime      @default(now()) @map("created_at")
  completedAt DateTime?     @map("completed_at")
  
  user        User          @relation(fields: [userId], references: [id])
  
  @@map("withdrawal_requests")
}

model PendingAccountChange {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  newAccountName   String   @map("new_account_name")
  newAccountNumber String   @map("new_account_number")
  newBankName      String   @map("new_bank_name")
  createdAt        DateTime @default(now()) @map("created_at")
  
  user             User     @relation(fields: [userId], references: [id])
  
  @@map("pending_account_changes")
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  message   String
  isAdmin   Boolean  @default(false) @map("is_admin")
  isDeleted Boolean  @default(false) @map("is_deleted")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id])

  @@map("chat_messages")
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

enum Role {
  AGENT
  AGGREGATOR
  ADMIN
}
