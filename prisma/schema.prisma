// This is your Prisma schema file.
// It tells Prisma what your database looks like.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. USERS TABLE (Unchanged)
model User {
  id                    String    @id @default(uuid())
  firstName             String    @map("first_name")
  lastName              String    @map("last_name")
  businessName          String?   @map("business_name")
  address               String?
  email                 String    @unique
  phoneNumber           String    @unique @map("phone_number")
  passwordHash          String    @map("password_hash")
  role                  Role      @default(AGENT)
  isPhoneVerified       Boolean   @default(false) @map("is_phone_verified")
  isEmailVerified       Boolean   @default(false) @map("is_email_verified")
  isIdentityVerified    Boolean   @default(false) @map("is_identity_verified")
  createdAt             DateTime  @default(now()) @map("created_at")
  bvn                   String?
  nin                   String?
  
  // --- Relations ---
  wallet                Wallet?
  virtualAccounts       VirtualAccount[]
  transactions          Transaction[]
  ninVerifications      NinVerification[]
  otps                  Otp[]

  @@map("users")
}

// 2. WALLETS TABLE (Unchanged)
model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  balance   Decimal  @default(0.00) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id])
  @@map("wallets")
}

// 3. VIRTUAL ACCOUNTS TABLE (Unchanged)
model VirtualAccount {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  bankName       String   @map("bank_name")
  accountNumber  String   @unique @map("account_number")
  accountName    String   @map("account_name")
  accountType    String   @default("STATIC") @map("account_type")
  reference      String   @unique
  user           User     @relation(fields: [userId], references: [id])
  @@map("virtual_accounts")
}

// 4. TRANSACTIONS TABLE (UPDATED)
model Transaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  type        String   // "DEPOSIT", "SERVICE_CHARGE", "UPGRADE_FEE", "WITHDRAWAL"
  amount      Decimal  @db.Decimal(12, 2) // e.g., -150.00
  description String
  reference   String   @unique
  status      String   // "COMPLETED", "PENDING", "FAILED"
  createdAt   DateTime @default(now()) @map("created_at")

  // --- NEW: Link to the service that was bought ---
  serviceId   String?  @map("service_id")
  service     Service? @relation(fields: [serviceId], references: [id])
  
  user        User     @relation(fields: [userId], references: [id])
  @@map("transactions")
}

// 5. NIN VERIFICATIONS TABLE (Unchanged)
model NinVerification {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  data            Json
  expiresAt       DateTime @map("expires_at")
  user            User     @relation(fields: [userId], references: [id])
  @@map("nin_verifications")
}

// 6. OTP TABLE (Unchanged)
model Otp {
  id        String   @id @default(uuid())
  code      String
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("otps")
}

// --- 7. NEW SERVICE TABLE ---
model Service {
  id               String    @id // e.g., "NIN_LOOKUP", "NIN_SLIP_REGULAR"
  name             String    // e.g., "NIN Verification Lookup"
  category         String    // e.g., "NIN"
  agentPrice       Decimal   @map("agent_price") @db.Decimal(10, 2)
  aggregatorPrice  Decimal   @map("aggregator_price") @db.Decimal(10, 2)
  isActive         Boolean   @default(true) @map("is_active")

  Transaction Transaction[] // Relation to transactions
  @@map("services")
}

// Enum for User Roles (Unchanged)
enum Role {
  AGENT
  AGGREGATOR
  ADMIN
}
