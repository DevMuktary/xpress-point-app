generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           String                 @id @default(uuid())
  firstName                    String                 @map("first_name")
  lastName                     String                 @map("last_name")
  businessName                 String?                @map("business_name")
  address                      String?
  email                        String                 @unique
  phoneNumber                  String                 @unique @map("phone_number")
  passwordHash                 String                 @map("password_hash")
  role                         Role                   @default(AGENT)
  isPhoneVerified              Boolean                @default(false) @map("is_phone_verified")
  isEmailVerified              Boolean                @default(false) @map("is_email_verified")
  isIdentityVerified           Boolean                @default(false) @map("is_identity_verified")
  createdAt                    DateTime               @default(now()) @map("created_at")
  bvn                          String?
  nin                          String?
  hasAgreedToModificationTerms Boolean                @default(false) @map("has_agreed_to_mod_terms")
  
  // --- Relations ---
  wallet                       Wallet?
  virtualAccounts              VirtualAccount[]
  transactions                 Transaction[]
  ninVerifications             NinVerification[]
  personalizationRequests      PersonalizationRequest[]
  ipeRequests                  IpeRequest[]
  validationRequests           ValidationRequest[]
  modificationRequests         ModificationRequest[]
  delinkRequests               DelinkRequest[] // <-- THIS IS THE "WORLD-CLASS" FIX
  otps                         Otp[]

  @@map("users")
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  balance   Decimal  @default(0.00) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id])
  @@map("wallets")
}

model VirtualAccount {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  bankName       String   @map("bank_name")
  accountNumber  String   @unique @map("account_number")
  accountName    String   @map("account_name")
  accountType    String   @default("STATIC") @map("account_type")
  reference      String   @unique
  user           User     @relation(fields: [userId], references: [id])
  @@map("virtual_accounts")
}

model Transaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  type        String
  amount      Decimal  @db.Decimal(12, 2)
  description String
  reference   String   @unique
  status      String
  createdAt   DateTime @default(now()) @map("created_at")
  
  serviceId   String?  @map("service_id")
  service     Service? @relation(fields: [serviceId], references: [id])
  
  user        User     @relation(fields: [userId], references: [id])
  
  verificationId String?            @map("verification_id")
  verification   NinVerification? @relation(fields: [verificationId], references: [id], onDelete: SetNull)

  @@map("transactions")
}

model NinVerification {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  data            Json
  expiresAt       DateTime @map("expires_at")
  user            User     @relation(fields: [userId], references: [id])
  transactions    Transaction[]

  @@map("nin_verifications")
}

model Otp {
  id        String   @id @default(uuid())
  code      String
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("otps")
}

model Service {
  id                  String                 @id
  name                String
  category            String
  agentPrice          Decimal                @map("agent_price") @db.Decimal(10, 2)
  aggregatorPrice     Decimal                @map("aggregator_price") @db.Decimal(10, 2)
  isActive            Boolean                @default(true) @map("is_active")
  
  Transaction         Transaction[]
  ModificationRequest ModificationRequest[]
  NewspaperRequest    NewspaperRequest[]
  
  @@map("services")
}

enum RequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model PersonalizationRequest {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  trackingId     String        @map("tracking_id")
  status         RequestStatus @default(PROCESSING)
  statusMessage  String?       @map("status_message")
  data           Json?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  user           User          @relation(fields: [userId], references: [id])
  @@unique([userId, trackingId])
  @@map("personalization_requests")
}

model IpeRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  trackingId      String        @map("tracking_id")
  newTrackingId   String?       @map("new_tracking_id")
  status          RequestStatus @default(PROCESSING)
  statusMessage   String?       @map("status_message")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  @@unique([userId, trackingId])
  @@map("ipe_requests")
}

model ValidationRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  nin             String        @map("nin")
  scode           String
  newTrackingId   String?       @map("new_tracking_id")
  status          RequestStatus @default(PROCESSING)
  statusMessage   String?       @map("status_message")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  @@unique([userId, nin, scode])
  @@map("validation_requests")
}

model ModificationRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  serviceId       String        @map("service_id")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  formData        Json
  attestationUrl  String?       @map("attestation_url")
  uploadedSlipUrl String?       @map("uploaded_slip_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  @@map("modification_requests")
}

model DelinkRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  nin             String        @map("nin")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  user            User          @relation(fields: [userId], references: [id])
  @@map("delink_requests")
}

model NewspaperRequest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  serviceId       String        @map("service_id")
  status          RequestStatus @default(PENDING)
  statusMessage   String?       @map("status_message")
  formData        Json
  publicationUrl  String?       @map("publication_url")
  pageNumber      String?       @map("page_number")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user            User          @relation(fields: [userId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  
  @@map("newspaper_requests")
}

enum Role {
  AGENT
  AGGREGATOR
  ADMIN
}
