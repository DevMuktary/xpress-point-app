import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getUserFromSession } from '@/lib/auth';
import axios from 'axios';
import { Decimal } from '@prisma/client/runtime/library';

// --- (All helper functions are still here, but unused for now) ---
function parseBvnData(data: any) {
  // ...
}
function formatPhoneForPayvessel(internationalPhone: string) {
  // ...
}
// ---------------------------------------------

export async function POST(request: Request) {
  console.log("\n--- [DEBUG] NEW WALLET ACTIVATION REQUEST ---");
  // 1. Get User
  const user = await getUserFromSession();
  if (!user) {
    console.error("[DEBUG] Auth check failed. User not found.");
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  console.log(`[DEBUG] User '${user.email}' authenticated.`);

  try {
    const body = await request.json();
    const { bvn, dob } = body; 
    console.log(`[DEBUG] Received BVN: ${bvn}, DOB: ${dob}`);

    if (!bvn || !dob) {
      console.error("[DEBUG] BVN or DOB missing.");
      return NextResponse.json({ error: 'BVN and Date of Birth are required' }, { status: 400 });
    }

    // --- THIS IS THE FIX (YOUR PLAN) ---
    // We are skipping all API calls and database logic
    // to test the connection.

    console.log("[DEBUG] System is fine. Skipping API calls and returning fake success.");

    // --- 10. Send FAKE Success Response ---
    // We send a 200 OK with a fake 'banks' array
    // This will make your modal's `handleActivateWallet` function succeed.
    return NextResponse.json({ 
      message: "DEBUG: Our system is fine and the request was received.",
      banks: [] // Send empty array to satisfy the frontend
    }, { status: 200 });

    /*
    // --- ALL ORIGINAL CODE IS COMMENTED OUT FOR DEBUGGING ---

    // --- 3. Get Price & Check Wallet ---
    const service = await prisma.service.findUnique({ where: { id: 'NIN_LOOKUP' } });
    if (!service) {
      console.error("[DEBUG] NIN_LOOKUP service not found.");
      return NextResponse.json({ error: 'Verification service (NIN_LOOKUP) not found.' }, { status: 503 });
    }
    
    const price = user.role === 'AGGREGATOR' 
      ? service.platformPrice 
      : service.defaultAgentPrice;
    
    const wallet = await prisma.wallet.findUnique({ where: { userId: user.id } });
    if (!wallet || wallet.balance.lessThan(price)) {
      console.error("[DEBUG] Insufficient funds.");
      return NextResponse.json({ error: `Insufficient funds. You need â‚¦${price}.` }, { status: 402 });
    }

    // --- 4. Call Raudah BVN API ---
    const userReference = `XPS-BVN-${user.id.substring(0, 5)}-${Date.now()}`;
    const raudahPayload = {
      value: bvn,
      ref: userReference
    };
    
    console.log("--- [DEBUG] Sending to Raudah ---");
    // ... (rest of API call) ...
    
    // --- 7. Update User & Charge Wallet ---
    // ... (rest of database transaction) ...

    // --- 8. Call Payvessel API ---
    // ... (rest of Payvessel call) ...

    // --- 9. Save Accounts to Database ---
    // ... (rest of account saving) ...
    
    */

  } catch (error: any) {
    console.error('--- [DEBUG] FINAL CATCH BLOCK ---');
    console.error('Wallet Activation Error:', error.message);
    // ---------------------------------
    return NextResponse.json(
      { error: error.message || 'An internal server error occurred.' },
      { status: 400 } 
    );
  }
}
