import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getUserFromSession } from '@/lib/auth';
import axios from 'axios';
import { Decimal } from '@prisma/client/runtime/library';

/**
 * Wallet Activation (BVN verification) route
 * 
 * Fixes the "string did not match the expected pattern" error
 * by correctly passing Decimal instances to Prisma for numeric fields.
 */

// --- Config / Endpoints ---
const RAUDAH_API_KEY = process.env.RAUDAH_API_KEY;
const RAUDAH_ENDPOINT = 'https://raudah.com.ng/api/bvn/bvn';

const PAYVESSEL_API_KEY = process.env.PAYVESSEL_API_KEY;
const PAYVESSEL_API_SECRET = process.env.PAYVESSEL_API_SECRET;
const PAYVESSEL_BUSINESS_ID = process.env.PAYVESSEL_BUSINESS_ID;
const PAYVESSEL_ENDPOINT =
  'https://api.payvessel.com/pms/api/external/request/customerReservedAccount/';

// ----------------- Helpers -----------------
function parseBvnData(data: any): {
  firstName: string | null;
  lastName: string | null;
  dateOfBirth: string | null;
  nin: string | null;
} {
  const coreData = data?.data?.data ?? data?.data ?? data;
  const firstName = data?.firstName || coreData?.firstname || coreData?.firstName || null;
  const lastName = data?.lastName || coreData?.surname || coreData?.lastName || null;
  const dateOfBirth = coreData?.dateOfBirth || coreData?.birthdate || null;
  const nin = coreData?.nin || null;
  return { firstName, lastName, dateOfBirth, nin };
}

function formatPhoneForPayvessel(internationalPhone: string | undefined): string {
  if (!internationalPhone) return '';
  if (internationalPhone.startsWith('+234')) {
    return '0' + internationalPhone.substring(4);
  }
  return internationalPhone;
}

function safeDecimal(value: unknown): Decimal {
  try {
    return new Decimal(value as any);
  } catch {
    return new Decimal(0);
  }
}

function isValidBvn(bvn: string): boolean {
  return /^\d{11}$/.test(bvn);
}

function isValidISODate(date: string): boolean {
  return /^\d{4}-\d{2}-\d{2}$/.test(date);
}

// ----------------- Route -----------------
export async function POST(request: Request) {
  console.log('\n--- [DEBUG] NEW WALLET ACTIVATION REQUEST ---');

  // 1. Authenticate
  const user = await getUserFromSession();
  if (!user) {
    console.error('[DEBUG] Auth check failed.');
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. Config validation
  if (!RAUDAH_API_KEY || !PAYVESSEL_API_KEY || !PAYVESSEL_API_SECRET || !PAYVESSEL_BUSINESS_ID) {
    console.error('[DEBUG] Missing API keys.');
    return NextResponse.json({ error: 'Server configuration error.' }, { status: 500 });
  }

  try {
    const body = await request.json();
    const { bvn, dob } = body ?? {};

    // Input validation
    if (!bvn || typeof bvn !== 'string' || !isValidBvn(bvn)) {
      return NextResponse.json({ error: 'Invalid BVN. Expected 11 digit string.' }, { status: 400 });
    }
    if (!dob || typeof dob !== 'string' || !isValidISODate(dob)) {
      return NextResponse.json({ error: 'Invalid Date of Birth. Expected format YYYY-MM-DD.' }, { status: 400 });
    }

    // 3. Fetch service & price
    const service = await prisma.service.findUnique({ where: { id: 'NIN_LOOKUP' } });
    if (!service) return NextResponse.json({ error: 'Service not found.' }, { status: 503 });

    const rawPrice = user.role === 'AGGREGATOR' ? service.platformPrice : service.defaultAgentPrice;
    const price = safeDecimal(rawPrice);

    // 4. Fetch wallet & ensure enough funds
    const wallet = await prisma.wallet.findUnique({ where: { userId: user.id } });
    if (!wallet) return NextResponse.json({ error: 'Wallet not found.' }, { status: 404 });

    const walletBalance = safeDecimal(wallet.balance);
    if (walletBalance.lessThan(price)) {
      return NextResponse.json(
        { error: `Insufficient funds. Required â‚¦${price.toString()}` },
        { status: 402 }
      );
    }

    // 5. Call Raudah BVN API
    const userReference = `XPS-BVN-${user.id.substring(0, 6)}-${Date.now()}`;
    const raudahPayload = { value: bvn, ref: userReference };
    const raudahHeaders = { 'Content-Type': 'application/json', Authorization: RAUDAH_API_KEY };

    let raudahData: any;
    try {
      const resp = await axios.post(RAUDAH_ENDPOINT, raudahPayload, { headers: raudahHeaders });
      raudahData = resp.data;
    } catch (err: any) {
      if (err.response && err.response.data && (err.response.data.success === true || err.response.data.status === true)) {
        raudahData = err.response.data;
      } else {
        return NextResponse.json({ error: 'BVN verification service unavailable.' }, { status: 503 });
      }
    }

    if (raudahData?.status === false || raudahData?.success === false) {
      const msg = raudahData?.message ?? 'BVN verification failed.';
      return NextResponse.json({ error: msg }, { status: 400 });
    }

    // 6. Parse BVN
    const { firstName, lastName, dateOfBirth, nin } = parseBvnData(raudahData);
    if (!firstName || !lastName || !dateOfBirth) {
      return NextResponse.json({ error: 'BVN record incomplete.' }, { status: 400 });
    }

    // Normalize DOB format
    let bvnDob = dateOfBirth;
    if (typeof bvnDob === 'string' && bvnDob.includes('-') && bvnDob.length === 10) {
      const parts = bvnDob.split('-');
      if (parts[0].length === 2 && parts[2].length === 4) bvnDob = `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    if (bvnDob !== dob) return NextResponse.json({ error: 'Date of Birth does not match BVN.' }, { status: 400 });

    const finalNin = nin || bvn;

    // 7. Prisma transaction: decrement wallet, create transaction, update user
    await prisma.$transaction([
      prisma.wallet.update({
        where: { userId: user.id },
        data: { balance: { decrement: price } }, // Decimal works directly
      }),
      prisma.transaction.create({
        data: {
          userId: user.id,
          serviceId: service.id,
          type: 'SERVICE_CHARGE',
          amount: price.negated(), // Decimal works
          description: 'BVN Verification (Wallet Activation)',
          reference: userReference,
          status: 'COMPLETED',
        },
      }),
      prisma.user.update({
        where: { id: user.id },
        data: { firstName, lastName, bvn, nin: finalNin, isIdentityVerified: true },
      }),
    ]);

    // 8. Call Payvessel API
    const payvesselPayload = {
      email: user.email,
      name: `${firstName} ${lastName}`,
      phoneNumber: formatPhoneForPayvessel(user.phoneNumber),
      bankcode: ['999991', '120001'],
      account_type: 'STATIC',
      businessid: PAYVESSEL_BUSINESS_ID,
      bvn,
      nin: finalNin,
    };

    let payvesselData: any;
    try {
      const resp = await axios.post(PAYVESSEL_ENDPOINT, payvesselPayload, {
        headers: {
          'api-key': PAYVESSEL_API_KEY ?? '',
          'api-secret': `Bearer ${PAYVESSEL_API_SECRET ?? ''}`,
          'Content-Type': 'application/json',
        },
        timeout: 15000,
      });
      payvesselData = resp.data;
    } catch (err: any) {
      return NextResponse.json({ error: 'Failed to create virtual accounts (Payvessel).' }, { status: 502 });
    }

    if (!payvesselData?.status || !Array.isArray(payvesselData.banks) || payvesselData.banks.length === 0) {
      return NextResponse.json({ error: payvesselData?.message || 'Failed to create virtual accounts.' }, { status: 502 });
    }

    // 9. Save virtual accounts
    const accountData = payvesselData.banks.map((bank: any) => ({
      userId: user.id,
      bankName: bank.bankName ?? 'Unknown',
      accountNumber: bank.accountNumber ?? '',
      accountName: bank.accountName ?? `${firstName} ${lastName}`,
      accountType: bank.account_type ?? 'STATIC',
      reference: bank.trackingReference ?? userReference,
      createdAt: new Date(),
      updatedAt: new Date(),
    }));

    try {
      await prisma.virtualAccount.createMany({ data: accountData });
    } catch (vaErr: any) {
      return NextResponse.json(
        { error: 'Virtual accounts created but saving to DB failed. Contact support.' },
        { status: 500 }
      );
    }

    // 10. Success response
    return NextResponse.json(
      { message: 'Wallet activated successfully!', banks: payvesselData.banks },
      { status: 200 }
    );
  } catch (err: any) {
    return NextResponse.json({ error: err?.message || 'Internal server error.' }, { status: 500 });
  }
}
